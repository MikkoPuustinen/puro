/*
 * MainFrame.cpp
 *
 *  Created on: Jul 16, 2013
 *      Author: oek
 */

#include "MainFrame.h"

MainFrame::MainFrame(uint16_t nIdeas, uint16_t nDrops) {

	engine_ = new Engine(this);
	audio_storage_ = new AudioStorage();
	worker_ = new Worker(this);
	interpreter_ = new Interpreter(this);

	ideas_.reserve(nIdeas);
	for (uint16_t i = 0; i < nIdeas; ++i) {
		ideas_.push_back(Idea());
		ideas_free_.push(&ideas_[i]);
	}

	drops_.reserve(nIdeas);
	for (uint16_t i = 0; i < nDrops; ++i) {
		drops_.push_back(Drop(this, GetBufferMaxLength()));
		drops_free_.push(&drops_[i]);
	}

}

MainFrame::~MainFrame() {
	delete interpreter_;
	delete engine_;
	delete audio_storage_;
	delete worker_;

	// IDEAS
	delete ideas_;
	delete ideas_in_use_;
	delete ideas_free_;

	// Drops
	delete drops_;
	delete drops_free_;

	delete onsets_;
}

Idea*
MainFrame::GetIdea(Tag association) {
	Idea* idea = ideas_in_use_[association];
	if (idea == 0) {
		idea = ideas_free_.pop();
		ideas_in_use_[association] = idea;
	}
	return idea;
}

float* MainFrame::GetAudioData(Tag material) {
	return audio_storage_->GetData(material);
}

float* MainFrame::GetAudioSize(Tag material) {
	return audio_storage_->GetSize(material);
}

void MainFrame::LoadAudioMaterial(Tag material, char* path) {
	audio_storage_->LoadFile(material, path);
}

void MainFrame::OnsetDrop(Idea* idea) {

	// TODO TIME
	// LOGIC TO INSERTING TO RIGHT SPOT WHEN TIME IS ADDED
	if (idea->IsValid()) {
		onsets_.push_back(idea);
	}
}

Idea*
MainFrame::GetOnset(uint16_t index) {
	return onsets_[index];
}

Drop*
MainFrame::PopFreeDrop() {
	drops_free_.pop();
}

// TODO TIME
void
MainFrame::ScheduleDrop(Drop* drop) {
	engine_->AddDrop(drop);
}

void
uint32_t GetBufferMaxLength() {
	return 262144;
}



