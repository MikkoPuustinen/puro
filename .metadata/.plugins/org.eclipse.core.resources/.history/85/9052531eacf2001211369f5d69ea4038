/*
 * Engine.cpp
 *
 *  Created on: Jul 15, 2013
 *      Author: oek
 */

#include "Engine.h"
#include "Drop.h"
#include "MainFrame.h"

Engine::Engine(MainFrame* instance) {
	std::cout << "Engine" << std::endl;
	instance_ = instance;
}

Engine::~Engine() {
}

void
Engine::AddDrop(Drop* drop) {
	DropBundle bundle;
	bundle.drop = drop;
	bundle.index = 0;
	drops_in_use_.push_back(bundle);
}

// TODO ADD TIMING
void
Engine::GetAudioOutput(uint32_t n, float* buffer) {
	instance_->Tick(n);
	// iterator running
	std::list<struct DropBundle>::iterator running = drops_in_use_.begin();
	while (running != drops_in_use_.end()) {
		uint32_t n_summed = running->drop->GetAudio(running->index, n, buffer);
		if (n_summed != n) {
			instance_->ReturnDepletedDrop(running->drop);
			running = drops_in_use_.erase(running);
		}
		else
			running++;
	}
}
